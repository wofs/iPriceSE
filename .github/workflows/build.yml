name: Build Lazarus Project

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Download and Install Free Pascal Compiler (FPC)
      run: |
        # Загружаем и устанавливаем FPC вручную
        Invoke-WebRequest -Uri https://sourceforge.net/projects/freepascal/files/Source/3.2.2/fpc-3.2.2.x86_64-win64.zip/download -OutFile fpc.zip
        Expand-Archive fpc.zip -DestinationPath C:\Lazarus\fpc
        # Добавляем FPC в PATH
        $env:PATH += ";C:\Lazarus\fpc\bin\i386-win32"

    - name: Set up Lazarus
      run: |
        # Установка Lazarus через Chocolatey
        choco install -y lazarus --install-args="'/D=C:\Lazarus'"

    - name: Verify FPC installation
      run: |
        # Проверяем, что FPC установлен правильно
        if (!(Test-Path "C:\Lazarus\fpc\bin\i386-win32\fpc.exe")) {
          throw "FPC not installed correctly!"
        }

    - name: Verify project file exists
      run: |
        # Проверяем, что файл проекта существует
        if (!(Test-Path "./ipricese.lpi")) {
          throw "Project file not found: ipricese.lpi"
        }

    - name: Build project
      run: |
        # Строим проект
        & "C:\Lazarus\lazbuild.exe" ipricese.lpi
